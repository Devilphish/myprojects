<!DOCTYPE html>
<html>
<head>
<style>

canvas { 
    border:1px solid #d3d3d3;
    background-color: #222222;
}   

</style>
</head>
<body onload="startView()">

<script>

var canvas;
var context;

var points = [
];

var eye_coord_init = [ 0, 5, -10 ]
var eye_coord = [];
// a vector is { y-axis-rot, x-axis-rot }
var eye_vector = { hrot: 0, vrot: 0 };

var rId;

var fovinput;
var fillinput;
var point_radiusinput;

function neon_log(x, y, w, h, vskew, hskew, color, bgcolor)
{
    var borderwidth = Math.max(Math.abs(vskew), Math.abs(hskew)) + 1;

    var log = document.createElement("PRE");
    log.style.position = "absolute";
    log.style.left = x + "px";
    log.style.top = y + "px";
    log.style.width = w + "px";
    log.style.height = h + "px";
    log.style.fontFamily = '"Seven Segment"';
//    log.style.font = "bold 20px arial,serif";
    log.style.font = "bold 20px \"Seven Segment\",regular";
    log.style.color = color;
    log.style.backgroundColor = bgcolor;
    log.style.opacity = "1.0";
    log.style.border = "0px";
    log.style.borderRadius = "7px";
    log.style.padding = "4px";

    var wlu1 = document.createElement("PRE");
    wlu1.style.position = "absolute";
    wlu1.style.top = y + vskew + 7 + "px";
    wlu1.style.left = x + hskew + "px";
    wlu1.style.width = w + 3 + "px";
    wlu1.style.height = h + 2 + "px";
    wlu1.style.color = color;
    wlu1.style.backgroundColor = bgcolor;
    wlu1.style.opacity = "1.0";
    wlu1.style.border = borderwidth + "px solid " + color;
    wlu1.style.borderRadius = "7px";

    var wlu2 = document.createElement("PRE");
    wlu2.style.position = "absolute";
    wlu2.style.top = y + (vskew * 2) + 7 + "px";
    wlu2.style.left = x + (hskew * 2) + "px";
    wlu2.style.width = w + 3 + "px";
    wlu2.style.height = h + 2 + "px";
    wlu2.style.color = color;
    wlu2.style.backgroundColor = bgcolor;
    wlu2.style.opacity = "0.8";
    wlu2.style.border = borderwidth + "px solid " + color;
    wlu2.style.borderRadius = "7px";

    var wlu3 = document.createElement("PRE");
    wlu3.style.position = "absolute";
    wlu3.style.top = y + (vskew * 3) + 7 + "px";
    wlu3.style.left = x + (hskew * 3) + "px";
    wlu3.style.width = w + 3 + "px";
    wlu3.style.height = h + 2 + "px";
    wlu3.style.color = color;
    wlu3.style.backgroundColor = bgcolor;
    wlu3.style.opacity = "0.3";
    wlu3.style.border = borderwidth + "px solid " + color;
    wlu3.style.borderRadius = "7px";

    document.body.appendChild(wlu3);
    document.body.appendChild(wlu2);
    document.body.appendChild(wlu1);
    document.body.appendChild(log);

    log.borders = [];
    log.borders[0] = wlu1;
    log.borders[1] = wlu2;
    log.borders[2] = wlu3;

    return log;
}

var coordmsg;

function log_eye()
{
    coordmsg.innerHTML = "eye location\n";
    coordmsg.innerHTML += eye_coord[0] + " " + eye_coord[1] + " " + eye_coord[2] + "\n\n";
    coordmsg.innerHTML += "eye vector\n";
    coordmsg.innerHTML += eye_vector.hrot + " " + eye_vector.vrot;
}

function keyDownEvent(e)
{
//    statusmsg.innerHTML = e.code;

    if (e.code == "Digit0") {
        eye_coord[0] = eye_coord_init[0];
        eye_coord[1] = eye_coord_init[1];
        eye_coord[2] = eye_coord_init[2];
        eye_vector.hrot = 0;
        eye_vector.vrot = 0;
    }
    if (e.code == "KeyA") {
        eye_coord[0] -= 5;
    }
    if (e.code == "KeyD") {
        eye_coord[0] += 5;
    }
    if (e.code == "KeyW") {
        eye_coord[1] += 5;
    }
    if (e.code == "KeyS") {
        eye_coord[1] -= 5;
    }
    if (e.code == "KeyQ") {
        eye_coord[2] += 5;
    }
    if (e.code == "KeyZ") {
        eye_coord[2] -= 5;
    }
    if (e.code == "ArrowLeft") {
        eye_vector.hrot += 2;
    }
    if (e.code == "ArrowRight") {
        eye_vector.hrot -= 2;
    }
    if (e.code == "ArrowUp") {
        eye_vector.vrot -= 2;
    }
    if (e.code == "ArrowDown") {
        eye_vector.vrot += 2;
    }
    if (eye_vector.hrot > 180) {
        eye_vector.hrot -= 360;
    }
    if (eye_vector.hrot < -180) {
        eye_vector.hrot += 360;
    }

    context.clearRect(0, 0, 1000, 1000);

    log_eye();
    draw_points();
    draw_boxes(boxes);
}

function keyUpEvent(e)
{
}

function xlate_3d(e_xyz, p_xyz)
{
    var x = p_xyz[0] - e_xyz[0];
    var y = p_xyz[1] - e_xyz[1];
    var z = p_xyz[2] - e_xyz[2];

    var h = Math.sqrt(x ** 2 + z ** 2);
    var v = Math.sqrt(y ** 2 + h ** 2);

    var theta_h;
    if (h == 0) {
        theta_h = 0;
    }
    else {
        theta_h = Math.asin(x / h) * 90 / (Math.PI / 2);
    }
    var theta_v;
    if (v == 0) {
        theta_v = 0;
    }
    else {
        theta_v = Math.asin(y / v) * 90 / (Math.PI / 2);
    }
    if (z < 0) {
        theta_h = 180 - theta_h;
        if (theta_h > 180) theta_h -= 360;
    }
if (0) {
// why is this not needed?
    if (y < 0) {
        theta_v = 180 - theta_v;
    }
}

    var p_v = {};
    p_v.hrot = theta_h;
    p_v.vrot = theta_v;
    p_v.r = v;

    return p_v;
}

var fov = 20;

function xlate_vector(p_v)
{
    var c_xy = {};
    c_xy.x = p_v.hrot * 500 / fov;
    c_xy.y = p_v.vrot * 500 / fov;

    return c_xy;
}

function threeD_to_canvasxy(point)
{

    var point_vector = xlate_3d(eye_coord, point);
    // adjust relative to eye_vector
    point_vector.hrot += eye_vector.hrot;
    if (point_vector.hrot > 180) point_vector.hrot -= 360;
    point_vector.vrot += eye_vector.vrot;
    if (point_vector.vrot > 180) point_vector.vrot -= 360;
    var canvas_xy = xlate_vector(point_vector);
    if (Math.abs(point_vector.hrot) > fov ||
        Math.abs(point_vector.vrot) > fov) {
        canvas_xy.out_of_frame = true;
    }
    else {
        canvas_xy.out_of_frame = false;
    }

    canvas_xy.x += 500;
    canvas_xy.y = 500 - canvas_xy.y;
    canvas_xy.r = point_vector.r;

    return canvas_xy
}

function face_visible(point, hrot, vrot)
{
    var point_vector = xlate_3d(eye_coord, point);

    if ((Math.abs(vrot) != 90 && Math.abs(hrot - point_vector.hrot) > 90) ||
        (vrot != 0 && Math.abs(vrot - point_vector.vrot) > 90)) {
        return true;
    }
    else {
        return false;
    }
}

var boxes = [
    { xyz: [ -10, 15, 75 ], whd: [ 10, 30, 70 ],
      color: "#80b3ff", borderColor: "#70a3ef" },
    { xyz: [  10, 15, 75 ], whd: [ 10, 30, 70 ],
      color: "#80b3ff", borderColor: "#70a3ef" },
    { xyz: [ -10, 25, 35 ], whd: [ 10, 50, 10 ],
      color: "#80b3ff", borderColor: "#70a3ef" },
    { xyz: [  10, 25, 35 ], whd: [ 10, 50, 10 ],
      color: "#80b3ff", borderColor: "#70a3ef" },
    { xyz: [ -10, 50, 25 ], whd: [ 10, 100, 10 ],
      color: "#80b3ff", borderColor: "#70a3ef" },
    { xyz: [  10, 50, 25 ], whd: [ 10, 100, 10 ],
      color: "#80b3ff", borderColor: "#70a3ef" },
    { xyz: [ -10, 5, 10 ], whd: [ 10, 10, 10 ],
      color: "#e580ff", borderColor: "#d570ef" },
    { xyz: [  10, 5, 10 ], whd: [ 10, 10, 10 ],
      color: "#e580ff", borderColor: "#d570ef" },
];

function draw_boxes(b)
{
    var visible_boxes = [];

    for (var i = 0; i < b.length; i++) {
        var point = [ b[i].xyz[0], eye_coord[1], b[i].xyz[2] ];
        var canvas_xy = threeD_to_canvasxy(point);
//        if (!canvas_xy.out_of_frame) {
        if (1) {
            canvas_xy.box = b[i];
            visible_boxes.push(canvas_xy);
        }
        visible_boxes.sort(function(a,b) {return b.r - a.r});
    }
    for (var i = 0; i < visible_boxes.length; i++) {
        draw_box(visible_boxes[i].box);
    }
}

var fill = 0;

function draw_box(b)
{
    var p_tbl = [ b.xyz[0] - b.whd[0] / 2,
                  b.xyz[1] + b.whd[1] / 2,
                  b.xyz[2] + b.whd[2] / 2 ];
    var p_tbr = [ b.xyz[0] + b.whd[0] / 2,
                  b.xyz[1] + b.whd[1] / 2,
                  b.xyz[2] + b.whd[2] / 2 ];
    var p_tfr = [ b.xyz[0] + b.whd[0] / 2,
                  b.xyz[1] + b.whd[1] / 2,
                  b.xyz[2] - b.whd[2] / 2 ];
    var p_tfl = [ b.xyz[0] - b.whd[0] / 2,
                  b.xyz[1] + b.whd[1] / 2,
                  b.xyz[2] - b.whd[2] / 2 ];
    var p_bbl = [ b.xyz[0] - b.whd[0] / 2,
                  b.xyz[1] - b.whd[1] / 2,
                  b.xyz[2] + b.whd[2] / 2 ];
    var p_bbr = [ b.xyz[0] + b.whd[0] / 2,
                  b.xyz[1] - b.whd[1] / 2,
                  b.xyz[2] + b.whd[2] / 2 ];
    var p_bfr = [ b.xyz[0] + b.whd[0] / 2,
                  b.xyz[1] - b.whd[1] / 2,
                  b.xyz[2] - b.whd[2] / 2 ];
    var p_bfl = [ b.xyz[0] - b.whd[0] / 2,
                  b.xyz[1] - b.whd[1] / 2,
                  b.xyz[2] - b.whd[2] / 2 ];
    var canvas_xy;

    context.fillStyle = b.color;
    context.strokeStyle = b.borderColor;

    // top face
    if (face_visible(p_tbl, 0, 90)) {
        context.beginPath();

        canvas_xy = threeD_to_canvasxy(p_tbl);
        context.moveTo(canvas_xy.x, canvas_xy.y);
        canvas_xy = threeD_to_canvasxy(p_tbr);
        context.lineTo(canvas_xy.x, canvas_xy.y);
        canvas_xy = threeD_to_canvasxy(p_tfr);
        context.lineTo(canvas_xy.x, canvas_xy.y);
        canvas_xy = threeD_to_canvasxy(p_tfl);
        context.lineTo(canvas_xy.x, canvas_xy.y);

        context.closePath();
        if (fill) {
            context.fill();
        }
        context.stroke();
    }

    // bottom face
    if (face_visible(p_bbl, 0, -90)) {
        context.beginPath();

        canvas_xy = threeD_to_canvasxy(p_bbl);
        context.moveTo(canvas_xy.x, canvas_xy.y);
        canvas_xy = threeD_to_canvasxy(p_bbr);
        context.lineTo(canvas_xy.x, canvas_xy.y);
        canvas_xy = threeD_to_canvasxy(p_bfr);
        context.lineTo(canvas_xy.x, canvas_xy.y);
        canvas_xy = threeD_to_canvasxy(p_bfl);
        context.lineTo(canvas_xy.x, canvas_xy.y);

        context.closePath();
        if (fill) {
            context.fill();
        }
        context.stroke();
    }

    // left face
    if (face_visible(p_bbl, -90, 0)) {
        context.beginPath();

        canvas_xy = threeD_to_canvasxy(p_bbl);
        context.moveTo(canvas_xy.x, canvas_xy.y);
        canvas_xy = threeD_to_canvasxy(p_tbl);
        context.lineTo(canvas_xy.x, canvas_xy.y);
        canvas_xy = threeD_to_canvasxy(p_tfl);
        context.lineTo(canvas_xy.x, canvas_xy.y);
        canvas_xy = threeD_to_canvasxy(p_bfl);
        context.lineTo(canvas_xy.x, canvas_xy.y);

        context.closePath();
        if (fill) {
            context.fill();
        }
        context.stroke();
    }

    // right face
    if (face_visible(p_bbr, 90, 0)) {
        context.beginPath();

        canvas_xy = threeD_to_canvasxy(p_bbr);
        context.moveTo(canvas_xy.x, canvas_xy.y);
        canvas_xy = threeD_to_canvasxy(p_tbr);
        context.lineTo(canvas_xy.x, canvas_xy.y);
        canvas_xy = threeD_to_canvasxy(p_tfr);
        context.lineTo(canvas_xy.x, canvas_xy.y);
        canvas_xy = threeD_to_canvasxy(p_bfr);
        context.lineTo(canvas_xy.x, canvas_xy.y);

        context.closePath();
        if (fill) {
            context.fill();
        }
        context.stroke();
    }

    // back face
    if (face_visible(p_bbr, 0, 0)) {
        context.beginPath();

        canvas_xy = threeD_to_canvasxy(p_bbr);
        context.moveTo(canvas_xy.x, canvas_xy.y);
        canvas_xy = threeD_to_canvasxy(p_tbr);
        context.lineTo(canvas_xy.x, canvas_xy.y);
        canvas_xy = threeD_to_canvasxy(p_tbl);
        context.lineTo(canvas_xy.x, canvas_xy.y);
        canvas_xy = threeD_to_canvasxy(p_bbl);
        context.lineTo(canvas_xy.x, canvas_xy.y);

        context.closePath();
        if (fill) {
            context.fill();
        }
        context.stroke();
    }

    // front face
    if (face_visible(p_bfr, -180, 0)) {
        context.beginPath();

        canvas_xy = threeD_to_canvasxy(p_bfr);
        context.moveTo(canvas_xy.x, canvas_xy.y);
        canvas_xy = threeD_to_canvasxy(p_tfr);
        context.lineTo(canvas_xy.x, canvas_xy.y);
        canvas_xy = threeD_to_canvasxy(p_tfl);
        context.lineTo(canvas_xy.x, canvas_xy.y);
        canvas_xy = threeD_to_canvasxy(p_bfl);
        context.lineTo(canvas_xy.x, canvas_xy.y);

        context.closePath();
        if (fill) {
            context.fill();
        }
        context.stroke();
    }
}

var point_radius = 1;

function draw_points()
{
    var visible_points = [];

    for (var i = 0; i < points.length; i++) {
        var point = points[i];
        var canvas_xy = threeD_to_canvasxy(point);
        if (!canvas_xy.out_of_frame) {
            visible_points.push(canvas_xy);
        }
    }

    visible_points.sort(function(a,b) {return b.r - a.r});

    for (var i = 0; i < visible_points.length; i++) {
        var canvas_xy = visible_points[i];

        context.beginPath();
        context.arc(canvas_xy.x, canvas_xy.y, point_radius, 0, 2 * Math.PI);
        if (fill) {
//            context.fillStyle = point[3];
            context.fillStyle = points[0][3];
            context.fill();
        }
        else {
//            context.strokeStyle = point[3];
            context.strokeStyle = points[0][3];
            context.stroke();
        }
    }
}

function fovInput()
{
    fov = Number(fovinput.value);

    context.clearRect(0, 0, 1000, 1000);
    draw_points();
    draw_boxes(boxes);
}

function fillInput()
{
    fill = this.checked;

    context.clearRect(0, 0, 1000, 1000);
    draw_points();
    draw_boxes(boxes);
}

function point_radiusInput()
{
    point_radius = Number(point_radiusinput.value);

    context.clearRect(0, 0, 1000, 1000);
    draw_points();
    draw_boxes(boxes);
}

function startView()
{
    window.addEventListener('keydown', keyDownEvent);
    window.addEventListener('keyup', keyUpEvent);

    var w = 1000;
    var h = 1000;

    eye_coord[0] = eye_coord_init[0];
    eye_coord[1] = eye_coord_init[1];
    eye_coord[2] = eye_coord_init[2];

    canvas = document.createElement("canvas");
    canvas.width = w;
    canvas.height = h;
    canvas.backgroundColor = "#222222";
    document.body.appendChild(canvas);

    // field of view input
    fovinput = document.createElement("INPUT");
    fovinput.addEventListener("input", fovInput);
    fovinput.setAttribute("type", "number");
    fovinput.setAttribute("value", fov);
    fovinput.style.border = "2px solid #ffffff";
    fovinput.style.borderRadius = "2px";
    fovinput.style.width = "50px";
    fovinput.style.height = "33px";
    fovinput.style.padding = "0px";
    fovinput.style.position = "absolute";
    fovinput.style.opacity = "0.7";
    fovinput.style.left = 1020 + "px";
    fovinput.style.top = 420 + "px";
    fovinput.style.font = "bold 20px arial,serif";
    fovinput.style.textAlign = "center";
    fovinput.style.backgroundColor = "#66ffff";
    document.body.appendChild(fovinput);

    // point radius input
    point_radiusinput = document.createElement("INPUT");
    point_radiusinput.addEventListener("input", point_radiusInput);
    point_radiusinput.setAttribute("type", "number");
    point_radiusinput.setAttribute("value", point_radius);
    point_radiusinput.style.border = "2px solid #ffffff";
    point_radiusinput.style.borderRadius = "2px";
    point_radiusinput.style.width = "50px";
    point_radiusinput.style.height = "33px";
    point_radiusinput.style.padding = "0px";
    point_radiusinput.style.position = "absolute";
    point_radiusinput.style.opacity = "0.7";
    point_radiusinput.style.left = 1020 + "px";
    point_radiusinput.style.top = 460 + "px";
    point_radiusinput.style.font = "bold 20px arial,serif";
    point_radiusinput.style.textAlign = "center";
    point_radiusinput.style.backgroundColor = "#66ffff";
    document.body.appendChild(point_radiusinput);

    // fill input
    fillinput = document.createElement("INPUT");
    fillinput.addEventListener("input", fillInput);
    fillinput.setAttribute("type", "checkbox");
    fillinput.setAttribute("value", fill);
    fillinput.style.border = "10px solid #ffffff";
    fillinput.style.borderRadius = "2px";
    fillinput.style.width = "50px";
    fillinput.style.height = "33px";
    fillinput.style.padding = "0px";
    fillinput.style.position = "absolute";
    fillinput.style.opacity = "1.0";
    fillinput.style.left = 1020 + "px";
    fillinput.style.top = 500 + "px";
    fillinput.style.font = "bold 20px arial,serif";
    fillinput.style.textAlign = "center";
    fillinput.style.backgroundColor = "#66ffff";
    document.body.appendChild(fillinput);

    coordmsg = neon_log(1020, 520, 230, 140, -1, -2, "#80ff00", "#107010");
    log_eye();

    context = canvas.getContext("2d");

if (1) {
    points.push([ 0, 0, 10, "#80ff00" ]);
}
if (0) {
    points.push([ -10, -10, -10 ]);
    points.push([ -10, -10,  0 ]);
    points.push([ -10,  0,   0 ]);
    points.push([  10,  0,   0 ]);
    points.push([  10,  10,  0 ]);
    points.push([  10,  10,  10 ]);
}
if (0) {
    for (var i = 0; i < 100; i++) {
        points.push([ 0, 0, i, "#e580ff" ]);
        points.push([ i, 0, i, "#80b3ff" ]);
    }
}
if (0) {
    for (var z = 0; z < 100; z++) {
        points.push([ 10, 0, z ]);
        points.push([ 10, 10, z ]);
        points.push([ 10, -10, z ]);
        points.push([ -10, 0, z ]);
        points.push([ -10, 10, z ]);
        points.push([ -10, -10, z ]);
        points.push([ 0, 10, z ]);
        points.push([ 0, -10, z ]);
    }
}
if (1) {
    for (var i = 0; i < 10000; i++) {
        var x = Math.floor((Math.random() * 600) + 1) - 300;
//        var y = Math.floor((Math.random() * 600) + 1) - 300;
        var y = 0
        var z = Math.floor((Math.random() * 600) + 1) - 300;
        var point = [ x, y, z, "#80ff00" ];
        points.push(point);
    }
}
if (0) {
    for (var z = 0; z < 600; z++) {
        for (var x = -300; x <= 300; x++) {
            points.push([ x, 0, z ]);
        }
    }
}
if (1) {
    for (var z = 100; z < 200; z++) {
        for (var y = -10; y <= 10; y++) {
            for (var x = 100; x <= 120; x++) {
                points.push([ x, y, z ]);
            }
        }
    }
}

    context.clearRect(0, 0, 1000, 1000);

    log_eye();
    draw_points();
    draw_boxes(boxes);
}

</script>

</body>
</html>
