<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>

canvas {
    border:1px solid #d3d3d3;
    background-color: #7171f1;
}

</style>
</head>
<body onload="startPuzzle()">

<img id="Tile1.png">
<img id="Tile2.png">
<img id="Tile3.png">
<img id="Tile4.png">
<img id="Tile5.png">
<img id="Tile6.png">
<img id="Tile7.png">
<img id="Tile8.png">
<img id="Tile9.png">

<script>

var sq = [
    [-4, -2, 3, 2],
    [-1, 2, 3, -4],
    [-1, 4, 2, 1],
    [-3, -4, 1, 3],
    [1, -2, -3, 4],
    [1, -4, 3, 2],
    [3, 2, -1, -4],
    [1, 4, 3, -2],
    [-4, -2, -3, -1]
];

var cmps = [
    [[0, 1], [1, 3]],
    [[1, 1], [2, 3]],

    [[0, 2], [3, 0]],
    [[1, 2], [4, 0]],
    [[2, 2], [5, 0]],

    [[3, 1], [4, 3]],
    [[4, 1], [5, 3]],

    [[3, 2], [6, 0]],
    [[4, 2], [7, 0]],
    [[5, 2], [8, 0]],

    [[6, 1], [7, 3]],
    [[7, 1], [8, 3]],
];

// 1 = Harry
// 2 = Nick
// 3 = Brendon
// 4 = Taylor

var p = [];
var deck = [];
var rots = [];

var statusmsg;
var debugmsg;
var turnmsg;

var count = 0;

function test(ncmps)
{
    var ncmpsnew = ncmps - 1;
    var p0;
    var p1;
    var r0;
    var r1;
    var t0;
    var t1;
    var t;

    t0 = cmps[ncmpsnew][0][0];
    t1 = cmps[ncmpsnew][1][0];
    p0 = cmps[ncmpsnew][0][1];
    p1 = cmps[ncmpsnew][1][1];
    r0 = (rots[t0] + p0) % 4;
    r1 = (rots[t1] + p1) % 4;

    if (sq[deck[t0]][r0] == -sq[deck[t1]][r1]) {
        if (ncmpsnew) {
            if (test(ncmpsnew)) {
                return true;
            }
        }
        else {
            // GOT IT
            statusmsg.innerHTML = "GOT IT!";
            turnmsg.innerHTML = "";
            for (var t = 0; t < 3; t++) {
                turnmsg.innerHTML += deck[t] + "" + rots[t] + " ";
            }
            turnmsg.innerHTML += "\n";
            for (var t = 3; t < 6; t++) {
                turnmsg.innerHTML += deck[t] + "" + rots[t] + " ";
            }
            turnmsg.innerHTML += "\n";
            for (var t = 6; t < 9; t++) {
                turnmsg.innerHTML += deck[t] + "" + rots[t] + " ";
            }
            turnmsg.innerHTML += "\n";

            return true;
        }
    }

    return false;
}

function rotate(ntiles)
{
    var ntilesnew = ntiles - 1;

    for (var r = 0; r < 4; r++) {
        rots[ntilesnew] = r;

        if (ntilesnew) {
            if (rotate(ntilesnew)) {
                return true;;
            }
        }
        else {
            if (test(12)) {
                return true;
            }
        }
    }

    return false;
}

function permute(ntiles, tiles)
{
    var newtiles = [];
    var ntilesnew = ntiles - 1;

    for (var t = 0; t < ntiles; t++) {
        deck[ntilesnew] = tiles[t];

        for (var x = 0; x < t; x++) {
            newtiles[x] = tiles[x];
        }
        for (var x = t; x < ntilesnew; x++) {
            newtiles[x] = tiles[x+1];
        }

        if (ntilesnew) {
            if (permute(ntilesnew, newtiles)) {
                return true;;
            }
        }
        else {
            count++;

            if (rotate(9)) {
                renderDeck();

                return true;
            }
        }
    }

    return false;
}

function solve()
{
    var tiles = [];

    for (var t = 0; t < 9; t++) {
        tiles[t] = t;
    }

    permute(9, tiles, deck);
}

function keyDownEvent(e)
{
    if (e.code == "KeyR") {
        curtileImage.rot += 90;
        if (curtileImage.rot == 360) curtileImage.rot = 0;
        curtileImage.style.rotate = curtileImage.rot + "deg";
    }
    if (e.code == "KeyS") {
        solve();
    }
    if (e.code == "KeyD") {
        debugmsg.innerHTML = "deck: ";
        for (var i = 0; i < 9; i++) {
            var r = p[i].image.rot / 90;
            var t = Number(p[i].image.src[p[i].image.src.length - 5]);
            debugmsg.innerHTML += (t - 1) + ""  + r + " ";
        }
    }
}

function keyUpEvent(e)
{
}

function startPuzzle()
{
    window.addEventListener('keydown', keyDownEvent);
    window.addEventListener('keyup', keyUpEvent);
    document.body.style.backgroundColor = "#7171f1";

    debugmsg = document.getElementById('debuglog');
    debugmsg.style.position = "absolute";
    debugmsg.style.top = "760px";
    statusmsg = document.getElementById('statuslog');
    statusmsg.style.position = "absolute";
    statusmsg.style.top = "780px";
    statusmsg.innerHTML = "foo";
    turnmsg = document.getElementById('turnlog');
    turnmsg.style.position = "absolute";
    turnmsg.style.top = "800px";

    for (var i = 0; i < 9; i++) {
        var x = 55 + ((i % 3) * 250);
        var y = 5 + (Math.floor(i / 3) * 250);
        var tileName = "Tile" + (i + 1) + ".png";
        p[i] = new tile(250, 250, tileName, x, y, "image", 0, 0);
    }
}

function renderDeck()
{
    debugmsg.innerHTML = "deck: ";
    for (var i = 0; i < 9; i++) {
        p[i].image.rot = rots[i] * 90;
        p[i].image.style.rotate = p[i].image.rot + "deg";
        p[i].image.src = "Tile" + (deck[i] + 1) + ".png";
        debugmsg.innerHTML += deck[i] + "" + rots[i] + " ";
    }
}

var curtileImage = null;
var selectedTile = null;

function swapTiles(t1, t2)
{
}

function tileEnter()
{
    curtileImage = this;
}

function tileDownEvent()
{
    if (selectedTile != null) {
//        swapTiles(selectedTile, this);
        saverot = this.rot;
        savesrc = this.src;

        this.rot = selectedTile.rot;
        this.style.rotate = this.rot + "deg";
        this.src = selectedTile.src;

        selectedTile.rot = saverot;
        selectedTile.style.rotate = selectedTile.rot + "deg";
        selectedTile.src = savesrc;

        selectedTile.style.opacity = "1.0";

        selectedTile = null;
    }
    else {
        selectedTile = this;
        this.style.opacity = "0.7";
    }
}

function tile(width, height, image, x, y, type, xoffset, yoffset)
{
    this.image = document.getElementById(image);
    this.image.addEventListener("mouseenter", tileEnter);
    this.image.addEventListener("mousedown", tileDownEvent);
    this.image.rot = 0;
    this.image.src = image;
    this.image.style.position = "absolute";
    this.image.style.left = x + "px";
    this.image.style.top = y + "px";
    this.image.style.width = width + "px";
    this.image.style.height = height + "px";
}

</script>

<div style="text-align:center;width:480px;">
  <pre id="debuglog" font-weight="bold"> X:  Y:  </pre>
  <pre id="statuslog"></pre>
  <pre id="turnlog"> player: </pre>
</div>
</body>
</html>
